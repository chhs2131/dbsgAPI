<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dbsgapi.dbsgapi.ipo.mapper.IpoMapper">
    <select id="selectIpos" resultType="com.dbsgapi.dbsgapi.ipo.dto.IpoSummaryDto">


        SELECT ipo.ipo_index,
               stock_name,
               IF(INSTR(stock_name,'스팩')=0, stock_kinds, '스팩주') AS stock_kinds,
               stock_exchange,
               DATE_FORMAT(ipo_start_date, '%Y-%m-%d') ipo_start_date,
               DATE_FORMAT(ipo_end_date, '%Y-%m-%d') ipo_end_date,
               DATE_FORMAT(ipo_refund_date, '%Y-%m-%d') ipo_refund_date,
               DATE_FORMAT(ipo_debut_date, '%Y-%m-%d') ipo_debut_date,
               under.underwriter,
               ct.recent_comment
        FROM ipo LEFT OUTER JOIN
             (
                 SELECT ipo_comment.ipo_index, ipo_comment.regist_date, ipo_comment.comment_index AS recent_comment
                 FROM ipo_comment
                 WHERE (ipo_comment.ipo_index, ipo_comment.regist_date)
                           IN(
                           SELECT ipo_comment.ipo_index, MAX(ipo_comment.regist_date) FROM ipo_comment
                           GROUP BY ipo_comment.ipo_index
                       )
             ) AS ct
             ON ipo.ipo_index = ct.ipo_index LEFT OUTER JOIN
             (SELECT iu.ipo_index, GROUP_CONCAT(iu.under_name ORDER BY iu.ind_total_max DESC) AS underwriter
              FROM(
                      SELECT ipo_underwriter.ipo_index, ipo_underwriter.ind_total_max, IFNULL(uc2.underwriter_name, ipo_underwriter.under_name) AS under_name
                      FROM underwriter_code AS uc1 JOIN underwriter_code AS uc2 ON uc1.parents_code = uc2.underwriter_code
                                                   RIGHT OUTER JOIN ipo_underwriter ON uc1.underwriter_name LIKE ipo_underwriter.under_name) AS iu
              GROUP BY iu.ipo_index) AS under
             ON ipo.ipo_index = under.ipo_index
        ORDER BY ipo.ipo_start_date DESC
        LIMIT 100;
    </select>

    <select id="selectIpo" parameterType="Long" resultType="com.dbsgapi.dbsgapi.ipo.dto.IpoDto">
        SELECT ipo_index,
               stock_name,
               stock_exchange,
               IF(INSTR(stock_name,'스팩')=0, stock_kinds, '스팩주') AS stock_kinds,
               stock_code,
               dart_code,
               sector_code.sector_desc AS sector,
               profits,
               sales,

               DATE_FORMAT(ipo_forecast_start, '%Y-%m-%d') ipo_forecast_start,
               DATE_FORMAT(ipo_forecast_date, '%Y-%m-%d') ipo_forecast_end,
               DATE_FORMAT(ipo_start_date, '%Y-%m-%d') ipo_start_date,
               DATE_FORMAT(ipo_end_date, '%Y-%m-%d') ipo_end_date,
               DATE_FORMAT(ipo_refund_date, '%Y-%m-%d') ipo_refund_date,
               DATE_FORMAT(ipo_debut_date, '%Y-%m-%d') ipo_debut_date,

               lock_up_percent,
               ipo_institutional_acceptance_rate,
               ipo_price,
               ipo_price_low,
               ipo_price_high,
               ipo_min_deposit,

               put_back_option_who,
               put_back_option_price,
               put_back_option_deadline,
               tag,
               DATE_FORMAT(regist_date, '%Y-%m-%d %T') regist_date,
               DATE_FORMAT(update_date, '%Y-%m-%d %T') update_date
        FROM 	ipo LEFT OUTER JOIN sector_code ON ipo.sector = sector_code.sector_code
        WHERE 	ipo_index = #{ipoIndex}
    </select>

    <select id="selectIpoScheduleList" parameterType="Map" resultType="com.dbsgapi.dbsgapi.ipo.dto.IpoScheduleDto">
        SELECT ipo_index,
               stock_name,
               date_format(ipo_forecast_start,'%Y-%m-%d') ipo_forecast_start,
               date_format(ipo_forecast_date,'%Y-%m-%d') ipo_forecast_end,
               date_format(ipo_start_date, '%Y-%m-%d') ipo_start_date,
               date_format(ipo_end_date, '%Y-%m-%d') ipo_end_date,
               date_format(ipo_refund_date, '%Y-%m-%d') ipo_refund_date,
               date_format(ipo_debut_date, '%Y-%m-%d') ipo_debut_date
        FROM ipo
        WHERE
            (ipo_forecast_start BETWEEN #{startDate} AND #{endDate}) OR
            (ipo_forecast_date BETWEEN #{startDate} AND #{endDate}) OR
            (ipo_start_date BETWEEN #{startDate} AND #{endDate}) OR
            (ipo_end_date BETWEEN #{startDate} AND #{endDate}) OR
            (ipo_refund_date BETWEEN #{startDate} AND #{endDate}) OR
            (ipo_debut_date BETWEEN #{startDate} AND #{endDate})
    </select>

    <select id="selectIpoCommentList" parameterType="Map" resultType="com.dbsgapi.dbsgapi.ipo.dto.IpoCommentDto">
        SELECT ipo_comment.comment_index,
               ipo_comment.ipo_index,
               ipo.stock_name,
               ipo_comment.comment,
               ipo_comment.writer,
               date_format(ipo_comment.regist_date, '%Y-%m-%d %T') regist_date,
               ipo_comment.log_type,
               ipo_comment.change_log_json
        FROM ipo_comment
                 LEFT JOIN ipo ON ipo_comment.ipo_index = ipo.ipo_index
        ORDER BY comment_index DESC
        LIMIT #{limit} OFFSET #{offset};
    </select>

    <select id="selectIpoComment" parameterType="Long" resultType="com.dbsgapi.dbsgapi.ipo.dto.IpoCommentDto">
        SELECT comment_index,
               ipo_index,
               comment,
               writer,
               DATE_FORMAT(regist_date, '%Y-%m-%d') regist_date,
               log_type,
               change_log_json
        FROM 	ipo_comment
        WHERE 	ipo_index = #{ipoIndex}
        ORDER BY regist_date DESC
        LIMIT   100;
    </select>

    <select id="selectIpoUnderwriter" parameterType="Long" resultType="com.dbsgapi.dbsgapi.ipo.dto.IpoUnderwriterDto">
        SELECT
            ipo_underwriter.ipo_index,
            IFNULL(uc2.underwriter_name, ipo_underwriter.under_name) AS under_name,
            ipo_underwriter.ind_total_max,
            ipo_underwriter.ind_total_min,
            ipo_underwriter.ind_total_max,
            ipo_underwriter.ind_total_min,
            DATE_FORMAT(ipo_underwriter.update_date, '%Y-%m-%d') update_date
        FROM underwriter_code AS uc1 JOIN underwriter_code AS uc2 ON uc1.parents_code = uc2.underwriter_code
                                     RIGHT OUTER JOIN ipo_underwriter ON uc1.underwriter_name LIKE ipo_underwriter.under_name
        WHERE 	ipo_index = #{ipoIndex}
    </select>
</mapper>
